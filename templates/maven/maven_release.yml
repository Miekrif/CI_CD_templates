.scm_connect: &scm_connect
  - 'command -v ssh-agent > /dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  - ssh-keyscan -H 'gitlab.alfastrah.ru' >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts
  - git config --global user.email "TES-G@alfastrah.ru"
  - git checkout -B "$CI_COMMIT_REF_NAME"

maven_release:
  stage: release
  image: $OPENJDK_MAVEN_IMAGE_SLIM
  script:
    - *scm_connect
    - mvn $MAVEN_CLI_OPTS -Darguments=-DskipTests release:prepare
  artifacts:
    expire_in: 1 hour
    paths:
      - target/*.jar
  when: manual
  only:
    - master

rollback:
  stage: rollback
  image: $OPENJDK_MAVEN_IMAGE_SLIM
  script:
    - *scm_connect
    - mvn scm:untag release:rollback
  when: manual
  only:
    - master